name: ci
on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8
        ports: ['3306:3306']
        env:
          MYSQL_DATABASE: shortener
          MYSQL_USER: shorty
          MYSQL_PASSWORD: secret
          MYSQL_ROOT_PASSWORD: secret
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -psecret"
          --health-interval=10s --health-timeout=5s --health-retries=10
      redis:
        image: redis:7
        ports: ['6379:6379']
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none
          extensions: intl, pdo_mysql, redis

      - name: Composer install
        working-directory: app
        run: composer install -q --no-interaction --no-progress

      - name: Bootstrap test env (cache/compiled)
        working-directory: app
        run: |
          mkdir -p storage/framework/{cache,views,sessions} bootstrap/cache
          cp .env.example .env || true
          php -r "file_put_contents('.env', preg_replace('/^APP_ENV=.*/m','APP_ENV=testing', file_get_contents('.env')));"
          php -r "file_put_contents('.env', preg_replace('/^APP_DEBUG=.*/m','APP_DEBUG=false', file_get_contents('.env')));"
          php artisan key:generate
          php artisan migrate --force

      - name: Run tests
        working-directory: app
        run: vendor/bin/phpunit -d memory_limit=512M

      - name: Set Docker secrets env (optional)
        run: |
          echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_ENV
          echo "DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }}" >> $GITHUB_ENV

      - name: Set up QEMU
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build image (no push)
        if: ${{ env.DOCKERHUB_USERNAME == '' || env.DOCKERHUB_TOKEN == '' }}
        uses: docker/build-push-action@v6
        with:
          context: app
          file: app/Dockerfile
          push: false
          tags: shortener:ci

      - name: Build & push (optional)
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/build-push-action@v6
        with:
          context: app
          file: app/Dockerfile
          push: true
          tags: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/shortener:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
